<div class="container">
  <!-- Student Navigation -->
  <div class="navigation-section">
    <div class="navigation-header">
      <!-- Search Field -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Type to search..."
          (keydown.enter)="switchToFirstFilteredStudent()">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Student Navigation -->
      <div class="student-nav">
        @if (isLoading()) {
        <mat-spinner diameter="24"></mat-spinner>
        } @else {
        @if (filteredStudents() && filteredStudents()?.length) {
        @for (student of filteredStudents(); track student.id) {
        <button mat-button [class.active]="currentStudent()?.id === student.id" (click)="setCurrentStudent(student)">
          {{ student.name }}
        </button>
        }
        } @else {
        <span class="empty-message">
          @if (searchControl.value) {
          No matches found
          } @else {
          No students yet
          }
        </span>
        }
        }
      </div>

      <!-- Add Button -->
      <button mat-mini-fab color="primary" (click)="showAddStudentForm()">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </div>

  <!-- Current Student Card -->
  @if (currentStudent(); as student) {
  <div class="student-card-container" [@cardAnimation]="currentStudentIndex()" (touchstart)="onTouchStart($event)"
    (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)" #cardContainer>
    <mat-card class="student-card">
      <mat-card-header>
        <div class="student-avatar">
          <img *ngIf="student.photo" [src]="student.photo" [alt]="student.name">
          <mat-icon *ngIf="!student.photo" class="default-avatar">person</mat-icon>
        </div>

        <div class="student-header-info">
          <mat-card-title>{{ student.name }}</mat-card-title>
          <mat-card-subtitle>
            <div class="student-details">
              <span><mat-icon>phone</mat-icon>{{ student.phone || 'Not set' }}</span>
              <span><mat-icon>calendar_today</mat-icon>Started: {{ student.startDate | date:'shortDate' }}</span>
              @if (student.lastLesson) {
              <span><mat-icon>schedule</mat-icon>Last Lesson: {{ student.lastLesson | date:'shortDate' }}</span>
              }
            </div>
          </mat-card-subtitle>
        </div>

        <!-- Status Badges -->
        <div class="status-badges">
          <!-- Payment Status -->
          <div class="status-badge" [ngClass]="getPaymentStatusClass(student.paymentStatus)">
            <mat-icon>{{ getPaymentStatusIcon(student.paymentStatus) }}</mat-icon>
            <span>{{ getPaymentStatusText(student.paymentStatus) }}</span>
          </div>

          <!-- Test Readiness -->
          <div class="status-badge" [ngClass]="student.isReadyForTest ? 'ready' : 'not-ready'">
            <mat-icon>{{ student.isReadyForTest ? 'check_circle' : 'schedule' }}</mat-icon>
            <span>{{ student.isReadyForTest ? 'Ready for Test' : (30 - (student.lessonsCompleted || 0)) + ' more needed' }}</span>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Navigation -->
        <div class="card-navigation">
          <button mat-icon-button [disabled]="currentStudentIndex() === 0" (click)="previousStudent()">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <span class="student-counter">{{ currentStudentIndex() + 1 }} / {{ students()?.length || 0 }}</span>
          <button mat-icon-button [disabled]="currentStudentIndex() === (students()?.length ?? 0) - 1"
            (click)="nextStudent()">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="student-stats">
          <div class="stat-card payment-stat" [ngClass]="{'warning': (student.balance || 0) > 0}">
            <div class="stat-icon">
              <mat-icon>account_balance_wallet</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ (student.balance || 0) | currency:'USD':'symbol':'1.2-2' }}</div>
              <div class="stat-label">Balance {{ (student.balance || 0) > 0 ? 'Owed' : (student.balance || 0) < 0 ? 'Credit' : '' }}</div>
            </div>
          </div>

          <div class="stat-card lessons-stat">
            <div class="stat-icon">
              <mat-icon>school</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ student.lessonsCompleted || 0 }}</div>
              <div class="stat-label">Lessons Completed</div>
            </div>
          </div>

          <div class="stat-card progress-stat">
            <div class="stat-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ getTestProgressPercentage(student.lessonsCompleted || 0) }}%</div>
              <div class="stat-label">Test Progress</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button mat-stroked-button (click)="openPaymentDialog(student)">
            <mat-icon>payment</mat-icon>
            Record Payment
          </button>
          <button mat-stroked-button (click)="openProgressDialog(student)">
            <mat-icon>edit_note</mat-icon>
            Update Progress
          </button>
        </div>

        <!-- Progress Notes -->
        @if (student.progressNotes) {
        <div class="progress-notes">
          <h4><mat-icon>note</mat-icon>Progress Notes</h4>
          <p>{{ student.progressNotes }}</p>
        </div>
        }

        <!-- Lessons Section -->
        <div class="lessons-section">
          <div class="section-header">
            <h3>Recent Lessons</h3>
            <button mat-icon-button (click)="refreshLessons()" [disabled]="isLoading()">
              <mat-icon>refresh</mat-icon>
              @if (isLoading()) {
              <mat-spinner diameter="24"></mat-spinner>
              }
            </button>
          </div>

          @if (student.lessons && student.lessons.length > 0) {
          <div class="lessons-list">
            @for (lesson of student.lessons.slice(-5); track lesson.id || $index) {
            <div class="lesson-item">
              <div class="lesson-date">
                <mat-icon>event</mat-icon>
                <!-- Fixed: Remove timestampToDate pipe, just use date pipe -->
                {{ lesson.date | date:'shortDate' }}
              </div>
              <div class="lesson-duration">{{ lesson.duration }}min</div>
              <div class="lesson-cost" [ngClass]="{'paid': lesson.isPaid, 'unpaid': !lesson.isPaid}">
                {{ (lesson.cost || 0) | currency:'USD':'symbol':'1.2-2' }}
                <mat-icon>{{ lesson.isPaid ? 'check_circle' : 'schedule' }}</mat-icon>
              </div>
              <div class="lesson-notes" *ngIf="lesson.notes">{{ lesson.notes }}</div>
            </div>
            }
            @if (student.lessons.length > 5) {
            <div class="show-more">
              <button mat-button (click)="showAllLessons(student)">
                View All {{ student.lessons.length }} Lessons
              </button>
            </div>
            }
          </div>
          } @else {
          <p class="no-lessons">No lessons recorded yet</p>
          }

          <!-- Add Lesson Form -->
          <form [formGroup]="lessonForm" (ngSubmit)="addLesson(student.id!)" class="lesson-form">
            <h4>Add New Lesson</h4>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Date</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="date">
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Duration (minutes)</mat-label>
                <input matInput type="number" formControlName="duration">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Cost</mat-label>
                <input matInput type="number" formControlName="cost" step="0.01">
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="notes-field">
              <mat-label>Notes</mat-label>
              <textarea matInput formControlName="notes" rows="2"></textarea>
            </mat-form-field>

            <div class="form-actions">
              <mat-checkbox formControlName="isPaid">Mark as Paid</mat-checkbox>
              <button mat-raised-button color="primary" type="submit" [disabled]="!lessonForm.valid">
                Add Lesson
              </button>
            </div>
          </form>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  }

  <!-- Add Student Dialog -->
  @if (showForm()) {
  <div class="overlay" (click)="hideAddStudentForm()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <h2>Add New Student</h2>
      <form [formGroup]="studentForm" (ngSubmit)="addStudent()">
        <mat-form-field appearance="outline">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" placeholder="Enter student's name">
          <mat-error *ngIf="studentForm.get('name')?.hasError('required')">
            Name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Phone Number</mat-label>
          <input matInput formControlName="phone" placeholder="Enter phone number">
          <mat-icon matSuffix>phone</mat-icon>
          <mat-error *ngIf="studentForm.get('phone')?.hasError('required')">
            Phone number is required
          </mat-error>
          <mat-error *ngIf="studentForm.get('phone')?.hasError('invalidPhone')">
            Please enter a valid phone number
          </mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button mat-button type="button" (click)="hideAddStudentForm()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="!studentForm.valid">
            Add Student
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>