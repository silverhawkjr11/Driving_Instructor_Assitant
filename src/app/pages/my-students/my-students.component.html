<!-- src/app/pages/my-students/my-students.component.html -->
<div class="container">
  <!-- Student Navigation -->
  <div class="navigation-section">
    <!-- Top row: Search and Add Student button -->
    <div class="navigation-top">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>{{'search_students' | translate}}</mat-label>
        <input matInput [formControl]="searchControl" [placeholder]="'search_students' | translate"
          (keydown.enter)="switchToFirstFilteredStudent()">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <button mat-raised-button class="add-student-btn" (click)="showAddStudentForm()">
        <mat-icon>person_add</mat-icon>
        {{'add_student' | translate}}
      </button>
    </div>

    <!-- Student Navigation Pills -->
    <div class="student-navigation">
      @if (isLoading()) {
      <div class="loading-state">
        <mat-spinner diameter="32"></mat-spinner>
        <div class="loading-text">{{'loading_students' | translate}}</div>
      </div>
      } @else {
      @if (filteredStudents() && filteredStudents()?.length) {
      <div class="students-grid">
        @for (student of filteredStudents(); track student.id) {
        <button class="student-pill" [class.active]="currentStudent()?.id === student.id"
          (click)="setCurrentStudent(student)" [title]="student.phone || ('not_set' | translate)">
          {{ student.name }}
        </button>
        }
      </div>
      } @else {
      <div class="students-grid empty">
        <div class="empty-state">
          @if (searchControl.value) {
          <mat-icon>search_off</mat-icon>
          <div class="empty-title">{{'no_matches' | translate}}</div>
          <div class="empty-subtitle">{{'try_different_search' | translate}}</div>
          } @else {
          <mat-icon>school</mat-icon>
          <div class="empty-title">{{'no_students_yet' | translate}}</div>
          <div class="empty-subtitle">{{'click_add_student' | translate}}</div>
          }
        </div>
      </div>
      }
      }
    </div>
  </div>

  <!-- Current Student Card -->
  @if (currentStudent(); as student) {
  <div class="student-card-container" [@cardAnimation]="currentStudentIndex()" (touchstart)="onTouchStart($event)"
    (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)" #cardContainer>
    <mat-card class="student-card">
      <mat-card-header>
        <div class="student-avatar">
          <img *ngIf="student.photo" [src]="student.photo" [alt]="student.name">
          <mat-icon *ngIf="!student.photo" class="default-avatar">person</mat-icon>
        </div>

        <div class="student-header-info">
          <mat-card-title>{{ student.name }}</mat-card-title>
          <mat-card-subtitle>
            <div class="student-details">
              <span><mat-icon>phone</mat-icon>{{ student.phone || ('not_set' | translate) }}</span>
              <span><mat-icon>calendar_today</mat-icon>{{'started' | translate}}: {{ student.startDate | date:'shortDate' }}</span>
              @if (student.lastLesson) {
              <span><mat-icon>schedule</mat-icon>{{'last_lesson' | translate}}: {{ student.lastLesson | date:'shortDate' }}</span>
              }
            </div>
          </mat-card-subtitle>
        </div>

        <!-- Status Badges -->
        <div class="status-badges">
          <!-- Payment Status -->
          <div class="status-badge" [ngClass]="getPaymentStatusClass(student.paymentStatus)">
            <mat-icon>{{ getPaymentStatusIcon(student.paymentStatus) }}</mat-icon>
            <span>{{ getPaymentStatusText(student.paymentStatus) | translate }}</span>
          </div>

          <!-- Test Readiness -->
          <div class="status-badge" [ngClass]="student.isReadyForTest ? 'ready' : 'not-ready'">
            <mat-icon>{{ student.isReadyForTest ? 'check_circle' : 'schedule' }}</mat-icon>
            <span>{{ student.isReadyForTest ? ('ready_for_test' | translate) : (30 - (student.lessonsCompleted || 0)) + ' ' + ('more_needed' | translate) }}</span>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Navigation -->
        <div class="card-navigation">
          <button mat-icon-button [disabled]="currentStudentIndex() === 0" (click)="previousStudent()">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <span class="student-counter">{{ currentStudentIndex() + 1 }} / {{ students()?.length || 0 }}</span>
          <button mat-icon-button [disabled]="currentStudentIndex() === (students()?.length ?? 0) - 1"
            (click)="nextStudent()">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="student-stats">
         <div class="stat-card payment-stat" [ngClass]="getBalanceStatusClass(student.balance)">
          <div class="stat-icon">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ getAbsoluteBalance(student.balance) | currency:'ILS':'symbol':'1.2-2' }}</div>
            <div class="stat-label">
              {{'balance' | translate}} 
              {{ (student.balance || 0) > 0 ? ('balance_owed' | translate) : 
                (student.balance || 0) < 0 ? ('credit' | translate) : '' }}
            </div>
          </div>
</div>

          <div class="stat-card lessons-stat">
            <div class="stat-icon">
              <mat-icon>school</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ student.lessonsCompleted || 0 }}</div>
              <div class="stat-label">{{'lessons_completed' | translate}}</div>
            </div>
          </div>

          <div class="stat-card progress-stat">
            <div class="stat-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-value">{{ getTestProgressPercentage(student.lessonsCompleted || 0) }}%</div>
              <div class="stat-label">{{'test_progress' | translate}}</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button mat-stroked-button (click)="openPaymentDialog(student)">
            <mat-icon>payment</mat-icon>
            {{'record_payment' | translate}}
          </button>
          <button mat-stroked-button (click)="openProgressDialog(student)">
            <mat-icon>edit_note</mat-icon>
            {{'update_progress' | translate}}
          </button>
        </div>

        <!-- Progress Notes -->
        @if (student.progressNotes) {
        <div class="progress-notes">
          <h4><mat-icon>note</mat-icon>{{'progress_notes' | translate}}</h4>
          <p>{{ student.progressNotes }}</p>
        </div>
        }

        <!-- Lessons Section -->
        <div class="lessons-section">
          <div class="section-header">
            <h3>{{'recent_lessons' | translate}}</h3>
            <button mat-icon-button (click)="refreshLessons()" [disabled]="isLoading()">
              <mat-icon>refresh</mat-icon>
              @if (isLoading()) {
              <mat-spinner diameter="24"></mat-spinner>
              }
            </button>
          </div>

          @if (student.lessons && student.lessons.length > 0) {
          <div class="lessons-list">
            @for (lesson of student.lessons.slice(-5); track lesson.id || $index) {
            <div class="lesson-item">
              <div class="lesson-date">
                <mat-icon>event</mat-icon>
                {{ lesson.date | date:'shortDate' }}
                <span class="lesson-time">{{ lesson.startTime }}</span>
              </div>
              <div class="lesson-duration">{{ lesson.duration }}min</div>
              <div class="lesson-cost" [ngClass]="{'paid': lesson.isPaid, 'unpaid': !lesson.isPaid}">
                {{ (lesson.cost || 0) | currency:'ILS':'symbol':'1.2-2' }}
                <mat-icon>{{ lesson.isPaid ? 'check_circle' : 'schedule' }}</mat-icon>
              </div>
              <div class="lesson-notes" *ngIf="lesson.notes">{{ lesson.notes }}</div>
            </div>
            }
            @if (student.lessons.length > 5) {
            <div class="show-more">
              <button mat-button (click)="showAllLessons(student)">
                {{'view_all' | translate}} {{ student.lessons.length }} {{'lessons' | translate}}
              </button>
            </div>
            }
          </div>
          } @else {
          <p class="no-lessons">{{'no_lessons' | translate}}</p>
          }

          <!-- Add Lesson Form -->
          <form [formGroup]="lessonForm" (ngSubmit)="addLesson(student.id!)" class="lesson-form">
            <h4>{{'add_lesson' | translate}}</h4>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>{{'date' | translate}}</mat-label>
                <input matInput [matDatepicker]="datePicker" formControlName="date">
                <mat-datepicker-toggle matIconSuffix [for]="datePicker"></mat-datepicker-toggle>
                <mat-datepicker #datePicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>{{'start_time' | translate}}</mat-label>
                <input matInput [matTimepicker]="timePicker" formControlName="startTime">
                <mat-timepicker-toggle matIconSuffix [for]="timePicker"/>
                <mat-timepicker #timePicker/>
              </mat-form-field>
              </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>{{'duration_minutes' | translate}}</mat-label>
                <input matInput type="number" formControlName="duration">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>{{'cost' | translate}}</mat-label>
                <input matInput type="number" formControlName="cost" step="0.01">
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="notes-field">
              <mat-label>{{'notes' | translate}}</mat-label>
              <textarea matInput formControlName="notes" rows="2"></textarea>
            </mat-form-field>

            <div class="form-actions">
              <mat-checkbox formControlName="isPaid">{{'mark_as_paid' | translate}}</mat-checkbox>
              <button mat-raised-button color="primary" type="submit" [disabled]="!lessonForm.valid">
                {{'add_lesson' | translate}}
              </button>
            </div>
          </form>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  }

  <!-- Add Student Dialog -->
  @if (showForm()) {
  <div class="overlay" (click)="hideAddStudentForm()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <h2>{{'add_student' | translate}}</h2>
      <form [formGroup]="studentForm" (ngSubmit)="addStudent()">
        <mat-form-field appearance="outline">
          <mat-label>{{'name' | translate}}</mat-label>
          <input matInput formControlName="name" [placeholder]="'student_name' | translate">
          <mat-error *ngIf="studentForm.get('name')?.hasError('required')">
            {{'name_required' | translate}}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{'phone_number' | translate}}</mat-label>
          <input matInput formControlName="phone" [placeholder]="'phone_number' | translate">
          <mat-icon matSuffix>phone</mat-icon>
          <mat-error *ngIf="studentForm.get('phone')?.hasError('required')">
            {{'phone_required' | translate}}
          </mat-error>
          <mat-error *ngIf="studentForm.get('phone')?.hasError('invalidPhone')">
            {{'valid_phone' | translate}}
          </mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button mat-button type="button" (click)="hideAddStudentForm()">{{'cancel' | translate}}</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="!studentForm.valid">
            {{'add_student' | translate}}
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>
